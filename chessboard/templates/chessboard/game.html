<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Shared Chess Game</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.12.0/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; padding: 20px; }
    #board { width: 420px; margin: auto; }
    #log { height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ddd; padding: 10px; font-size: 0.9rem; }
    .card { border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>

<div class="container text-center">
  <h2 class="mb-3">‚ôü Shared Chess Game</h2>
  <div class="row justify-content-center">
    <div class="col-md-5">
      <div id="board"></div>
      <p class="mt-3">–•–æ–¥: <strong id="turn" class="text-primary">{{ turn }}</strong></p>
      <button id="reset-btn" class="btn btn-outline-danger btn-sm">‚ôªÔ∏è –°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É</button>
    </div>

    <div class="col-md-5">
      <div class="card p-3 mb-3">
        <h5>üìã –¢–∞–±–ª–∏—Ü–∞ —Ö–æ–¥–æ–≤</h5>
        <table class="table table-sm table-striped" id="moves-table">
          <thead>
            <tr>
              <th>‚Ññ</th>
              <th>–ë–µ–ª—ã–µ</th>
              <th>–ß—ë—Ä–Ω—ã–µ</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card p-3 mb-3">
        <h5>üßæ –õ–æ–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h5>
        <div id="log"></div>
      </div>

      <div class="card p-3">
        <h5>üìà –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h5>
        <canvas id="activityChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const board = Chessboard('board', {
  draggable: true,
  position: '{{ fen }}',
  pieceTheme: "https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png",
  onDrop: onDrop
});

const chess = new Chess('{{ fen }}');

// === –î–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É —Ö–æ–¥–∞–º–∏ ===
let lastMoveTime = null;
const moveIntervals = [];

const ctx = document.getElementById('activityChart');
const activityChart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: [],
    datasets: [{
      label: '‚è± –í—Ä–µ–º—è –º–µ–∂–¥—É —Ö–æ–¥–∞–º–∏ (—Å–µ–∫)',
      data: [],
      borderWidth: 2,
      backgroundColor: 'rgba(54, 162, 235, 0.6)',
    }]
  },
  options: {
    scales: {
      y: {
        beginAtZero: true,
        title: { display: true, text: '–°–µ–∫—É–Ω–¥—ã' }
      },
      x: {
        title: { display: true, text: '‚Ññ —Ö–æ–¥–∞' }
      }
    }
  }
});

function logAction(msg) {
  $('#log').append(`<div>${new Date().toLocaleTimeString()} ‚Äî ${msg}</div>`);
  $('#log').scrollTop($('#log')[0].scrollHeight);
}

function updateMovesTable() {
  const history = chess.history({ verbose: true });
  const tbody = $('#moves-table tbody');
  tbody.empty();

  for (let i = 0; i < history.length; i += 2) {
    const white = history[i] ? history[i].san : '';
    const black = history[i + 1] ? history[i + 1].san : '';
    tbody.append(`<tr><td>${Math.floor(i / 2) + 1}</td><td>${white}</td><td>${black}</td></tr>`);
  }
}

function updateTimeChart() {
  const now = new Date();
  let interval = 0;

  if (lastMoveTime) {
    interval = Math.round((now - lastMoveTime) / 1000);
  }

  lastMoveTime = now;
  moveIntervals.push(interval);

  activityChart.data.labels.push(moveIntervals.length);
  activityChart.data.datasets[0].data.push(interval);
  activityChart.update();
}

function onDrop(source, target) {
  const move = chess.move({ from: source, to: target, promotion: 'q' });
  if (move === null) return 'snapback';

  $.post("/", {
    move: move.san,
    csrfmiddlewaretoken: '{{ csrf_token }}'
  }).done((data) => {
    if (data.valid) {
      board.position(data.fen);
      $('#turn').text(data.turn);
      updateMovesTable();
      updateTimeChart();
      logAction(`–•–æ–¥: ${move.san} (${data.turn} —Ç–µ–ø–µ—Ä—å —Ö–æ–¥–∏—Ç)`);
    } else {
      alert("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ö–æ–¥");
      board.position(chess.fen());
    }
  }).fail(() => alert("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º"));
}

$('#reset-btn').click(() => {
  $.post("/", {
    action: "reset",
    csrfmiddlewaretoken: '{{ csrf_token }}'
  }).done((data) => {
    if (data.reset) {
      chess.reset();
      board.start();
      $('#turn').text("white");
      $('#moves-table tbody').empty();
      $('#log').empty();
      lastMoveTime = null;
      moveIntervals.length = 0;
      activityChart.data.labels = [];
      activityChart.data.datasets[0].data = [];
      activityChart.update();
      logAction("‚ôªÔ∏è –ò–≥—Ä–∞ —Å–±—Ä–æ—à–µ–Ω–∞.");
    }
  }).fail(() => alert("‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –∏–≥—Ä—ã"));
});

</script>

</body>
</html>